# 3.6.16 Multipath Path Selection

本节描述用于负载均衡网络的路径选择算法。**建议**UET 端点对 RUD 和 RUDI 流量执行多路径负载均衡，但具体的实现方式留给实现方决定。

该协议依赖多路径转发，将流量中的数据包分发到多条网络路径上。除了单路径的ROD服务外，数据包分发通常采用逐包等价多路径（ECMP）方式，即利用网络头字段的哈希运算，将数据包分发到多条路径上。与单路径传输相比，这种方法能够实现更高的吞吐量和更短的流完成时间。

一些网络交换机可以自行执行数据包分散，而不是通过对头字段进行哈希运算来确定路径。如果使用了路径感知多路径分散（3.6.16.4节），建议不要对UET流量启用这种行为，因为这会妨碍UET获取有关哪些路径发生拥塞的清晰信号。

尽管尝试了均衡分配流量，但特定路径仍可能出现拥堵。哈希算法无法保证均匀地分发数据包。未被分散的其他流量的存在可能会影响某些路径上的可用带宽。此外，故障可能导致某条路径不可用。如果源端主动平衡流量，就可以提高吞吐量并减少流完成时间。

---

## 3.6.16.1 Path Entropy

当采用数据包分散（packet spraying）时，通过改变数据包头部中携带熵值（EV）的熵字段的值，将数据包分散到多条路径上（见3.6.10.1节）。交换机使用熵字段来确定每个数据包通过哪条等价多路径（ECMP）到达目的地。允许的三种操作模式如下：

- **单路径（Single path）**（仅ROD使用）。在 EV 更换之前，CCC中的所有数据包在一段时间内使用同一个 EV。 
- **随机喷洒（Oblivious spraying）**：CCC的数据包通过改变EV值（通常至少有256个值）在多个路径上进行喷射，以实现流量在所有可能路径上的均匀分布。
- **路径感知喷洒（Path-aware spraying）**：CCC的数据包通过自适应地改变EV来避免拥塞路径，从而在许多路径上进行喷射，这基于目的地提供的关于哪些EV看到了拥塞的反馈。

---

## 3.6.16.2 Single-Path Entropy

PDC 启动时，可靠性模块会生成一个 `AllocateCCC()` 事件，其中 sprayed=FALSE。CCC 会为流量数据包选择一个熵值。为确保在路由未发生变化或数据包未丢失的情况下，数据包按顺序到达，该 CCC 一次只使用一个熵值。

如果观察到网络拥塞，并确定拥塞不是发生在通往目的地的最终链路上（无法通过重新路由避免），则 CCC 可以更改其使用的熵值。为尽量减少重新排序和任何潜在重传的影响，建议 CCC 要么在流量空闲时更改熵值；如果没有闲置期，也不要比每 t_reroute RTTs 更改一次熵值更频繁。

流量在空闲多长时间后才会改变熵值是一种配置选择。在没有数据包传输的情况下随时切换是安全的，但这种保守的选择并不一定能提高性能。建议将 t_reroute 的默认值设置为至少 10 个 RTT，并可对该值进行配置。

如果源和目的地之间存在一个以上的单路径 PDC，PDS 应请求为它们分配不同的 CCC。同一对 FEP 之间的不同 CCC 应协调分配不同的熵值，以减少 CCC 使用同一单一路径的频率。

> 信息文本：
使用不同但相互协调的 CCC 的目的是减少流冲突的影响。如果不同的 PDC 使用不同的 EV，那么一个PDC 上的流冲突就不太可能影响到另一个 PDC，同时也能缓解拥塞。

---

## 3.6.16.3 Oblivious Multipath Spraying

源会维护一个用于 CCC 的熵值空间，但不会保存有关哪些熵值比其他熵值拥塞程度低的信息。熵空间的典型大小为 256 个值，但也可使用其他大小的空间。数据源应按伪随机顺序使用熵空间中的熵值，目标是在重复使用之前使用一次所有熵值。每个信号源定期独立地重新随机化伪随机序列，以降低多个信号源在散列为类似路径序列的序列上同步的概率，这样做是有益的。

源如何选择伪随机序列是由实现定义的。简单的模块化计数器虽然不是伪随机的，但足以满足协议互操作性的要求，因此是允许的，但它依赖于交换机 ECMP 哈希函数来提供伪随机负载平衡。这在许多部署中可能已经足够。如果是这样，计数器应随机初始化，以避免同步。

遗忘喷射与数据包修剪相结合时最为有效。通过数据包修剪，在发生拥塞丢失时，信源会迅速收到来自目的地的 NACK，并在拥塞控制允许的情况下尽快重传数据包。重新传输的数据包很可能会选择不同的路径。使用一个 BDP 左右的相对较低的修剪阈值可以防止队列不必要地扩大，而且由于修剪后的数据包在拥塞瓶颈处占用的容量很小，并能在不同路径上引起快速重传，因此带有修剪功能的遗忘喷射可以很好地主动平衡网络负载。

我们不鼓励不进行数据包修剪的遗忘式喷洒，因为它导致的负载平衡效果不如路径感知喷洒均衡。不过，在没有数据包修剪的网络中，如果信源无法保持足够的每路径状态，它可能会选择使用遗忘喷射。

---

## 3.6.16.4 Path-aware Multipath Spraying

与 oblivious spraying 类似，源端仍维护一组 EV，但根据拥塞反馈动态调整使用。EV 空间大小应设为能在 2 RTT 内循环使用的程度，以确保反馈及时。

在 ACK/NACK 中，目的端返回分组的 EV 及 `pds.flags.m`（是否遇到拥塞，基于 IP ECN-CE 位），也可结合其他遥测方式判断拥塞。

收到设置 `m` 标志的反馈后，源端应避免在 1 RTT 内重复使用该 EV。

若发现大多数路径都拥塞，说明负载均衡信号已饱和，则可取消对 EV 的跳过。此“拥塞比例阈值”应可配置，推荐默认值为 **50%**。

避免重复路径的两种方法：

- **REPS 方法**：通过 ACK 中未标记的 EV 回填 EV 缓存，优先使用“未拥塞”的 EV；结合一个小循环缓存（如 8 个值）以降低开销。
- **位图方法**：每个 EV 映射一个比特，收到反馈后标记为拥塞，选择 EV 时跳过标记值；空间大小根据 RTT 动态调整。

也可结合两者或使用其他机制。路径感知喷洒允许更主动的流量均衡。

---
